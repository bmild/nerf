FROM nvidia/cuda:12.3.2-cudnn9-devel-ubuntu20.04

RUN apt-get update && \
    apt-get install -y wget

## Install Nsight Systems
RUN wget https://developer.nvidia.com/downloads/assets/tools/secure/nsight-systems/2024_4/NsightSystems-linux-cli-public-2024.4.1.61-3431596.deb

# Set the timezone
RUN ln -sf /usr/share/zoneinfo/Asia/Tokyo /etc/localtime 

RUN apt-get install -y ./NsightSystems-linux-cli-public-2024.4.1.61-3431596.deb

RUN rm ./NsightSystems-linux-cli-public-2024.4.1.61-3431596.deb && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

RUN sysctl -w kernel.perf_event_paranoid=1

## Install basic tools
RUN apt-get install -y make build-essential
# RUN curl https://pyenv.run | bash
# RUN pyenv install 3.7.17

RUN echo 'export PATH="$HOME/.pyenv/bin:$PATH"' >> ~/.bashrc && \
    echo 'eval "$(pyenv init --path)"' >> ~/.bashrc && \
    echo 'eval "$(pyenv init -)"' >> ~/.bashrc && \
    echo 'eval "$(pyenv virtualenv-init -)"' >> ~/.bashrc && \
    echo 'export PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION=python' >> ~/.bashrc

# RUN /root/.pyenv/bin/pyenv install 3.7.17 && \
#     /root/.pyenv/bin/pyenv global 3.7.17

RUN wget https://www.python.org/ftp/python/3.7.17/Python-3.7.17.tgz && \
    tar -xzf Python-3.7.17.tgz

RUN cd Python-3.7.17 && \
    ./configure --enable-optimizations && \
    make -j$(nproc) && \
    make altinstall

RUN rm -rf Python-3.7.17 Python-3.7.17.tgz && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

RUN update-alternatives --install /usr/bin/python3 python3 /usr/local/bin/python3.7 1 && \
    update-alternatives --install /usr/bin/pip3 pip3 /usr/local/bin/pip3.7 1

CMD [ "/bin/bash" ]
